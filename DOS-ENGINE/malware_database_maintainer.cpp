// SWAMI KARUPPASWAMI THUNNAI

#include"Malware.h"
#include"sqlite_modern_cpp.h"
#include<map>
#include<set>
#include<exception>
using namespace sqlite;

/*
This .cpp file is used for handling database, it deals with addition of signatures
matching, maintaining etc., and etc., 

*/




// This method is for preventing accidental crash of the application
template<typename malwares>
Malware<malwares>::Malware()
{
	std::map<std::string, std::string> numericals;
	numericals["0"] = "zero";
	numericals["1"] = "one";
	numericals["2"] = "two";
	numericals["3"] = "three";
	numericals["4"] = "four";
	numericals["5"] = "five";
	numericals["6"] = "six";
	numericals["7"] = "seven";
	numericals["8"] = "eight";
	numericals["9"] = "nine";
	std::string alpha = "abcdefghijklmnopqrstuvwxyz";
	typedef std::map<std::string, std::string>::iterator iterator;
	database db("ksgmprh.db");
	for (int i = 0; i < alpha.size(); i++)
	{
		std::string table_name(1,alpha[i]);
		std::cout << "\nchecking the database...\n";
		std::string query = "create table if not exists " + table_name + " (";
		try
		{
			std::string schema = query + "hash text primary key not null,variant text not null);";
			db << schema;
		}
		catch (std::exception &e)
		{
			std::cout << e.what();
		}
	}
	iterator itr1 = numericals.begin();
	iterator itr2 = numericals.end();
	for (iterator itr = itr1; itr != itr2; ++itr)
	{
		std::string table_name = itr->second;
		std::string query = "create table if not exists " + table_name + " (";
		try
		{
			std::string schema = query + "hash text primary key not null,variant text not null);";
			db << schema;
		}
		catch (std::exception &e)
		{
			std::cout << e.what() << "\n";
		}
	}
}


// Ifthe hash is matches this method will return true else false
template<typename malwares>
bool Malware<malwares>::check_in_database(std::string hash)
{
	bool status = false;
	try
	{
		// this is the location of the database, I think I need to change the location in
		//future
		database db("ksgmprh.db");
		std::string table_name(1, hash[0]);
		// the below one is used if the hash starts with any numericals then finding in appropirate tables 
		std::map<std::string, std::string> numericals;
		numericals["0"] = "zero";
		numericals["1"] = "one";
		numericals["2"] = "two";
		numericals["3"] = "three";
		numericals["4"] = "four";
		numericals["5"] = "five";
		numericals["6"] = "six";
		numericals["7"] = "seven";
		numericals["8"] = "eight";
		numericals["9"] = "nine";
		std::map<std::string, std::string>::iterator itr = numericals.find(table_name);
		// If the table name starts with numericals then,
		std::string query = "select hash,variant from ";
		if (itr != numericals.end())query += itr->second;
		else query += table_name;
		query += " where hash = ? ;";
		// so now we got our query properly
		db << query << hash >> [&](std::unique_ptr<std::string> value, std::string type) {
			if (value != nullptr) status = true;
			else status = false;
		};
	}
	catch (std::exception &e)
	{
		std::cout << e.what();
		status = false;
	}
	return status;
}

template class Malware<std::wstring>;